<div id="headerWrapper" style="background-color: #<%= params[:color] || "CFD1D1" %>">
  <div id="header">
    <% if params[:size] == 'lg' %>
      <img alt="Picture of " src="" class="full_name@alt+ pic@src" />
    <% end %>
    <div id="topWrapper">
      <h1>
        <small class="title"></small><big class="full_name">Stephanie Herseth Sandlin</big>
      </h1>
    
      <div class="state_downcase@class" id="lawmakerMetadata">
        <span class="party"></span>
        <span class="state"></span>
      </div>
    </div>
    <div class="clear"></div>
    <div id="nav">
      <ul>
        <li class="upcoming" style="display: none">
          <a href="#">
            <%= params[:size] == 'sm' ? "New" : "Upcoming" %> Parties
          </a>
        </li>
        <li class="recent" style="display: none">
          <a href="#">
            Recent Parties
          </a>
        </li>
      </ul> 
      <div class="clear"></div>
    </div>
    
  </div>
</div>

<div id="mainContent">
  <ol class="upcoming" style="display: none"></ol>
  <ol class="recent" style="display: none"></ol>
</div>


<script type="text/javascript" charset="utf-8">

  var description = "Party details taken from Sunlight's <a href=\"http://politicalpartytime.org/\" target=\"_blank\">Party Time</a>.";


  loadWidget("legislator", ["basic", "parties"], {bioguide_id: bioguide_id}, function(data) {
    var legislator = data.legislator;
    
    var legislator_district = "";
    if (legislator.district == '0')
      legislator_district = "AL";
    else
      legislator_district = legislator.district;
    
    var legislator_state = "";
    if (legislator.title == "Sen")
      legislator_state = legislator.state;
    else
      legislator_state = legislator.state + "-" + legislator_district;
    
    var widget_data = {
      title: shortTitle(legislator),
      full_name: fullName(legislator),
      pic: profileImage(legislator.bioguide_id, "40x50"),
      state_downcase: legislator.state.toLowerCase(),
      state: legislator_state,
      party: partyFor(legislator)
    };
    
    $("div#pageMain").autoRender(widget_data);
    
    // set up the tab contents and interaction
    var upcoming = [];
    var recent = [];
    
    var now = new Date();
    $.each(legislator.parties.events, function(i, event) {
      // combine date and start_time into the moment of the event
      var date = globalizedDate(event.date); // UTCify just the date portion
      var pieces = event.start_time.split(":");
      date.setHours(parseInt(pieces[1]));
      date.setMinutes(parseInt(pieces[2]));
      
      if (date.getTime() < now)
        recent.unshift(event);
      else
        upcoming.unshift(event);
    });
    
    // slice each array, hing it on the size (3 for large, otherwise 2)
    var n = size == 'lg' ? 3 : 2;
    upcoming = upcoming.slice(0, n);
    recent = recent.slice(0, n);
    
    // if both are empty, display empty message
    if (upcoming.length == 0 && recent.length == 0)
      $("#mainContent").append("<p>No recent or upcoming parties for this legislator.</p>");
    else {
      if (upcoming.length > 0) {
        $.each(upcoming, function(i, event) {
          $("#mainContent ol.upcoming").append(partyItemFor(event, size));
        });
        
        $("#nav li.upcoming").show();
        
        $("#mainContent ol.upcoming").show();
        $("#nav li.upcoming").addClass("active");
        
        $("#nav li.upcoming a").click(function() {
          $("#mainContent ol.recent").hide();
          $("#nav li.recent").removeClass("active");
          
          $("#mainContent ol.upcoming").show();
          $("#nav li.upcoming").addClass("active");
          return false;
        });
        
      }
      
      if (recent.length > 0) {
        $.each(recent, function(i, event) {
          $("#mainContent ol.recent").append(partyItemFor(event, size));
        });
        
        $("#nav li.recent").show();
        
        // if there's no upcoming tab, this one needs to be visible and active
        if (upcoming.length == 0) {
          $("#mainContent ol.recent").show();
          $("#nav li.recent").addClass("active");
        }
        
        $("#nav li.recent a").click(function() {
          $("#mainContent ol.upcoming").hide();
          $("#nav li.upcoming").removeClass("active");
          
          $("#mainContent ol.recent").show();
          $("#nav li.recent").addClass("active");
          return false;
        });
        
      }
    }
    
    updateSource(legislator.parties.last_updated, description);
  });
  
  
  function partyItemFor(event, size) {
    var date = globalizedDate(event.date);
    
    var month = monthShort(date.getMonth());
    var day = date.getDate();
    
    var pieces = event.start_time.split(":");
    var hours = parseInt(pieces[0]);
    var minutes = pieces[1];
    var meridian = (hours < 12) ? "am" : "pm";
    
    if (hours == 0)
      hours = 12;
    else if (hours > 12)
      hours -= 12;
      
    var time = hours + ":" + minutes + meridian;
    
    return "<li>" +
      "<div class=\"date\">" +
        "<span class=\"month\">" + month + "</span>" + 
        "<span class=\"day\">" + day + "</span>" +
      "</div>" +
      "<div class=\"details\">" +
        "<span class=\"time\">" + time + " -</span>" +
        "<span>" + event.type + " at " + event.venue + "</span>" +
        (size == 'sm' ? "" : "<span class=\"contribution\">" + event.contribution_info + "</span>") + 
      "</div>" +
      "<div class=\"clear\"></div>" +
      "</li>";
  }
</script>