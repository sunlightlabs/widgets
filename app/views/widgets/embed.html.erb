<% content_for :head do %>
  <%= stylesheet_link_tag "widgets/#{params[:id]}" %>
  
  <script type="text/javascript">
    // config variables
    var data_endpoint = "<%= settings[:data_endpoint] %>";
    var sunlight_api_key = "<%= settings[:sunlight_api_key] %>";
    var snapshot_directory = "<%= settings[:snapshot_directory] %>";
    
    var bioguide_id = "<%= params[:bioguide_id] %>".toUpperCase();
    var size = "<%= @size %>";
    var snapshot_id = "<%= params[:snapshot_id] %>";
    
    
    // geolocation
    var geolocate = false;
    var latitude, longitude, located_legislator;
    <% if params[:geolocate] %>
      geolocate = true;
      
      <% if @location %>
        latitude = "<%= @location[:latitude] %>";
        longitude = "<%= @location[:longitude] %>";
      <% end %>
    <% end %>
    
    
    // api keys
    Sunlight.api_key = sunlight_api_key;
    Drumbone.base_url = data_endpoint;
    Drumbone.api_key = sunlight_api_key;
    TransparencyData.api_key = sunlight_api_key;
    
    
    var Widget = {
      load: function(bioguide_id) {}, // overwritten by each child widget before document is done loading
      
      onLoad: function(legislator) {
        prepareSource();
        $("body").show();
      },
      
      onLoadSwitcher: function(legislator) {
        prepareSwitcher(legislator, Widget.onLoad);
      },
      
      alert: function(message) {
        $("#pageMain").hide();
        $("#widgetAlert p").html(message);
        $("#widgetAlert").show();
        $("body").show();
      },
      
      error: function(message) {
        $("#widgetAlert").addClass("error");
        Widget.alert(message);
      },
      
      source: function(date, text) {
        $("#last_updated").html(formatSourceDate(new Date(date)));
        $("#sourceContent").html(text);
      }
    };
    
    $(function() {
      if (geolocate) {
        if (latitude && longitude) {
          Sunlight.allForLatLong(latitude, longitude, function(legislators) {
            if (legislators != null && legislators.length) {
              located_legislator = pullOutRep(legislators);
              Widget.load(located_legislator.bioguide_id, Widget.onLoadSwitcher);
            }
            else // geolocated the user, but found no legislator for that lat/long (user may be non-US)
              Widget.load(bioguide_id, Widget.onLoadSwitcher);
          });
          
        } else // geolocation is enabled for the widget, but we couldn't figure out where the user is
          Widget.load(bioguide_id, Widget.onLoadSwitcher);
        
      } else // geolocation is disabled for the widget
        Widget.load(bioguide_id, Widget.onLoad);
    });
    
    // pull out the first legislator whose title is not 'Sen', 
    // and if there is none (i.e. open seat) then just return the first one
    function pullOutRep(legislators) {
      var index = -1;
      $.each(legislators, function(i, legislator_object) {
        var legislator = legislator_object.legislator;
        if (legislator.title != 'Sen') {
          index = i;
          return false; // jQuery's way of doing a "break"
        }
      });
      return legislators[index > -1 ? index : 0].legislator;
    }
    
    function prepareSource() {
      $("div#sources a.sourceText").toggle(
        function(){
          $(this).addClass("active");
          $("div#sourceArea").slideDown("slow");
          return false;
        },
        function() {
          $(this).removeClass("active");
          $("div#sourceArea").slideUp("slow");
          return false;
        } 
      );
    }
    
    // needs to be idempotent - may be called repeatedly as users switch states/legislators
    function prepareSwitcher(legislator, showCallback) {
      $("div#changeLawmaker a#closeBtn").click(function() {
        $("div#changeLawmaker").hide();
        return false;
      });
      
      $("div#changeLawmaker span.current_name").html(fullName(legislator));
      
      $("div#changeLawmaker select.state")
        .unbind('change')
        .val(legislator.state)
        .change(switchState);
      
      
      $("div#changeLawmaker").show();
      
      $("a.changeState").click(function() {
        $("div#changeLawmaker").toggle();
        return false;
      }).show();
      
      Sunlight.allForState(legislator.state, function(legislators) {
        if (legislators == null)
          Widget.error("There was a problem loading legislators from " + state + ".");
        else {
          $("span.full_name").hide();
          $("small.title").hide();
          $("select.changeLawmakerSelect")
            .unbind("change")
            .html(optionsForSwitcher(legislators))
            .val(legislator.bioguide_id)
            .change(switchLegislator)
            .show();
          
          if (showCallback)
            showCallback();
        }
      });
    }
    
    function switchLegislator() {
      Widget.load($(this).val(), onSwitchLegislator);
    }
    
    function onSwitchLegislator(legislator) {
      $("div#changeLawmaker span.current_name").html(fullName(legislator));
      $("div#changeLawmaker").hide();
      $("a.changeState").click(function() {
        $("div#changeLawmaker").toggle();
        return false;
      })
      $("select.changeLawmakerSelect")
        .val(legislator.bioguide_id)
        .change(switchLegislator);
    }
    
    function switchState() {
      var state = $(this).val();
      Sunlight.allForState(state, function(legislators) {
        if (legislators == null)
          Widget.error("There was a problem loading legislators from " + state + ".");
        else
          Widget.load(legislators[0].legislator.bioguide_id, onSwitchState);
      });
    }
    
    function onSwitchState(legislator) {
      prepareSwitcher(legislator);
    }
    
    function optionsForSwitcher(legislators) {
      var options = "";
      $.each(legislators, function(index, l) {
        var legislator = l.legislator;
        options += "<option value=\"" + legislator.bioguide_id + "\">" + titledName(legislator, true) + "</option>";
      });
      return options;
    }
    
  </script>
<% end %>

<% content_for :body_class, "#{params[:id]}_#{params[:size]} #{params[:size]}" %>

<%= render "widgets/embed/#{params[:id]}" %>