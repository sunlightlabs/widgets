<% content_for :head do %>
  <%= stylesheet_link_tag "widgets/#{params[:id]}" %>
  
  <script type="text/javascript">
    var data_endpoint = "<%= settings[:data_endpoint] %>";
    var sunlight_api_key = "<%= settings[:sunlight_api_key] %>";
    var snapshot_directory = "<%= settings[:snapshot_directory] %>";
    
    var bioguide_id = "<%= params[:bioguide_id] %>".toUpperCase();
    var size = "<%= @size %>";
    var snapshot_id = "<%= params[:snapshot_id] %>";
    
    
    // The main widget loading function. If a snapshot_id is set, it'll use that, otherwise, 
    // it'll use the given Drumbone parameters to pull from the live site.
    function loadWidget(url, callback) {
      // override URL if a snapshot ID is present
      if (snapshot_id)
        url = snapshotUrl(snapshot_directory, snapshot_id);
        
      return $.ajax({
        url: url,
        dataType: "jsonp",
        jsonpCallback: "politiwidgetsCallback",
        
        success: function(data) {
          if (data.error)
            setError("Error loading widget.<br/><br/>Error message: " + data.error.code + " - " + data.error.message);
          else
            callback(data);
          
          showWidget();
        }
        
      });
    }
    
    function loadDrumboneWidget(method, sections, options, callback) {
      var url = drumboneUrl(data_endpoint, method, $.extend(options, {
        apikey: sunlight_api_key,
        sections: sections.join(",")
      }));
      
      loadWidget(url, callback);
    }
    
    function showWidget() {
      $("div#sources a.sourceText").toggle(
        function(){
          $(this).addClass("active");
          $("div#sourceArea").slideDown("slow");
          $(".highcharts-container").hide();
          return false;
        },
        function() {
          $(this).removeClass("active");
          $("div#sourceArea").slideUp("slow", function() {
            $(".highcharts-container").show();        
          });
          
          return false;
        } 
      );

      $("body").show();
    }

    function setAlert(message) {
      $("#pageMain").hide();
      $("#widgetAlert p").html(message);
      $("#widgetAlert").show();
      $("body").show();
    }

    function setError(message) {
      $("#widgetAlert").addClass("error");
      setAlert(message);
    }

    function updateSource(date, text) {
      $("#last_updated").html(formatSourceDate(new Date(date)));
      $("#sourceContent").html(text);
    }
    
    // stub to be overridden, this whole thing is a big IE hack
    function doneLoadingMap() {}
  </script>
<% end %>

<% content_for :body_class, "#{params[:id]}_#{params[:size]} #{params[:size]}" %>

<%= render "widgets/embed/#{params[:id]}" %>